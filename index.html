<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Portal AR Experience</title>
    <style>
        /* ... (keep all your existing styles) ... */
    </style>
</head>
<body>
    <div id="ar-container"></div>
    <img id="audio-indicator" alt="Audio indicator">
    <div id="loading">Loading assets...</div>
    <div id="instructions">
        <img id="instruction-image" alt="Scan a wall" style="width: 80%; max-width: 400px; margin-bottom: 20px;">
        <p>Point your camera at a wall surface</p>
        <p>Tap to place the portal</p>
        <button id="start-button">Start AR</button>
        <div id="ar-button-container"></div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/three@0.132.2/build/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.132.2/examples/js/loaders/GLTFLoader.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.132.2/examples/js/webxr/ARButton.js"></script>

    <script>
        // Configuration - Update these paths to match your actual files
        const ASSETS = {
            model: 'PortalANimMus-02.glb',
            audioIndicator: 'earphone.png',
            instructionImage: 'Firstimage.png',
            audio: 'museumversion_250709.mp3'
        };

        // Global variables
        let camera, scene, renderer, controller;
        let model, audio;
        let reticle, hitTestSource = null;
        let modelPlaced = false;

        async function init() {
            // Check for WebXR support
            if (!navigator.xr) {
                showError("WebXR not supported. Try Chrome on an ARCore-compatible Android device.");
                return;
            }

            // Initialize Three.js
            initThreeJS();

            try {
                // Load all assets with progress feedback
                await loadAllAssets();
                document.getElementById('loading').style.display = 'none';
                document.getElementById('instructions').style.display = 'flex';
                
                // Create AR button after successful loading
                createARButton();
            } catch (error) {
                showError(`Failed to load assets: ${error.message}`);
                console.error("Loading error:", error);
            }
            
            // Start render loop
            renderer.setAnimationLoop(render);
        }

        function initThreeJS() {
            // Create scene
            scene = new THREE.Scene();
            
            // Create camera
            camera = new THREE.PerspectiveCamera(70, window.innerWidth / window.innerHeight, 0.01, 20);
            
            // Create renderer
            renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
            renderer.setPixelRatio(window.devicePixelRatio);
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.xr.enabled = true;
            document.getElementById('ar-container').appendChild(renderer.domElement);
            
            // Set up controller
            controller = renderer.xr.getController(0);
            controller.addEventListener('select', onSelect);
            scene.add(controller);
            
            // Create reticle
            reticle = new THREE.Mesh(
                new THREE.RingGeometry(0.05, 0.1, 32).rotateX(-Math.PI / 2),
                new THREE.MeshBasicMaterial({ color: 0xffffff, transparent: true, opacity: 0.5 })
            );
            reticle.visible = false;
            reticle.matrixAutoUpdate = false;
            scene.add(reticle);
            
            // Handle window resize
            window.addEventListener('resize', onWindowResize);
        }

        async function loadAllAssets() {
            // Update loading text
            document.getElementById('loading').textContent = "Loading assets...";
            
            // Load instruction image
            await loadImage(ASSETS.instructionImage, 'instruction-image');
            
            // Load audio indicator image
            await loadImage(ASSETS.audioIndicator, 'audio-indicator');
            
            // Load 3D model
            await loadModel(ASSETS.model);
            
            // Preload audio (but don't play yet)
            await loadAudio(ASSETS.audio);
        }

        function loadImage(src, elementId) {
            return new Promise((resolve, reject) => {
                const img = document.getElementById(elementId);
                img.onload = () => resolve();
                img.onerror = () => reject(new Error(`Failed to load image: ${src}`));
                img.src = src;
            });
        }

        function loadModel(url) {
            return new Promise((resolve, reject) => {
                const loader = new THREE.GLTFLoader();
                loader.load(
                    url,
                    (gltf) => {
                        model = gltf.scene;
                        model.visible = false;
                        scene.add(model);
                        resolve();
                    },
                    undefined,
                    (error) => reject(new Error(`Model load failed: ${error.message}`))
                );
            });
        }

        function loadAudio(url) {
            return new Promise((resolve) => {
                audio = new Audio(url);
                audio.loop = true;
                audio.preload = "auto";
                audio.oncanplaythrough = () => resolve();
                audio.onerror = () => resolve(); // Continue even if audio fails
            });
        }

        function createARButton() {
            const arButton = ARButton.createButton(renderer, { 
                requiredFeatures: ['hit-test'],
                optionalFeatures: ['dom-overlay'],
                domOverlay: { root: document.body }
            });
            arButton.classList.add('ar-button');
            document.getElementById('ar-button-container').appendChild(arButton);
        }

        // ... (keep all your existing functions like onSelect, render, showError, etc.) ...
        // Handle tap/select event
        function onSelect() {
            if (modelPlaced || !reticle.visible) return;
            
            // Place model 50cm in front of the wall
            const position = new THREE.Vector3();
            const quaternion = new THREE.Quaternion();
            const scale = new THREE.Vector3();
            
            reticle.matrix.decompose(position, quaternion, scale);
            
            // Move 50cm forward from the wall
            const forward = new THREE.Vector3(0, 0, -0.5);
            forward.applyQuaternion(quaternion);
            position.add(forward);
            
            model.position.copy(position);
            model.quaternion.copy(quaternion);
            model.visible = true;
            modelPlaced = true;
            reticle.visible = false;
            
            // Show audio indicator
            const audioIndicator = document.getElementById('audio-indicator');
            audioIndicator.style.opacity = 1;
            
            // Fade out after 4 seconds
            setTimeout(() => {
                audioIndicator.style.opacity = 0;
            }, 4000);
            
            // Start audio after 5 seconds
            setTimeout(() => {
                if (audio) {
                    audio.play().catch(e => console.log("Audio play requires user interaction first"));
                }
            }, 5000);
            
            // Hide instructions
            document.getElementById('instructions').style.display = 'none';
        }

        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }

        function render() {
            if (!renderer.xr.isPresenting) return;
            
            if (controller && !modelPlaced) {
                const session = renderer.xr.getSession();
                if (session && hitTestSource) {
                    const referenceSpace = renderer.xr.getReferenceSpace();
                    const frame = renderer.xr.getFrame();
                    
                    const hitTestResults = frame.getHitTestResults(hitTestSource);
                    if (hitTestResults.length > 0) {
                        const hit = hitTestResults[0];
                        reticle.visible = true;
                        reticle.matrix.fromArray(hit.getPose(referenceSpace).transform.matrix);
                    } else {
                        reticle.visible = false;
                    }
                }
            }
            
            renderer.render(scene, camera);
        }

        function showError(message) {
            const errorDiv = document.createElement('div');
            errorDiv.style.position = 'absolute';
            errorDiv.style.top = '0';
            errorDiv.style.left = '0';
            errorDiv.style.width = '100%';
            errorDiv.style.padding = '20px';
            errorDiv.style.backgroundColor = 'red';
            errorDiv.style.color = 'white';
            errorDiv.style.zIndex = '1000';
            errorDiv.textContent = message;
            document.body.appendChild(errorDiv);
            
            document.getElementById('loading').style.display = 'none';
        }

        document.getElementById('start-button').addEventListener('click', async () => {
            try {
                const session = await navigator.xr.requestSession('immersive-ar', {
                    requiredFeatures: ['hit-test']
                });
                
                const referenceSpace = await session.requestReferenceSpace('local');
                const viewerSpace = await session.requestReferenceSpace('viewer');
                hitTestSource = await session.requestHitTestSource({
                    space: viewerSpace,
                    entityTypes: ['plane'],
                    offsetRayOrigin: true
                });
                
                document.getElementById('start-button').style.display = 'none';
                document.querySelector('.ar-button').style.display = 'block';
                await renderer.xr.setSession(session);
            } catch (error) {
                showError("AR failed to start: " + error.message);
            }
        });

        // Start the application
        init().catch(error => {
            showError("Initialization failed: " + error.message);
        });
    </script>
</body>
</html>
