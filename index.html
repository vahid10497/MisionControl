<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Portal AR Experience</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            overflow: hidden;
            font-family: Arial, sans-serif;
        }
        #ar-container {
            position: absolute;
            width: 100%;
            height: 100%;
        }
        #instructions {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            text-align: center;
            z-index: 100;
        }
        #start-button {
            margin-top: 20px;
            padding: 10px 20px;
            font-size: 16px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        #audio-indicator {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 100px;
            height: 100px;
            opacity: 0;
            z-index: 10;
            transition: opacity 1s;
            pointer-events: none;
        }
        #loading {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            background-color: rgba(0, 0, 0, 0.8);
            color: white;
            z-index: 200;
        }
    </style>
</head>
<body>
    <div id="ar-container"></div>
    <img id="audio-indicator" src="earphone.png" alt="Audio indicator">
    <div id="loading">Loading assets...</div>
    <div id="instructions">
        <img src="Firstimage.png" style="width: 80%; max-width: 400px; margin-bottom: 20px;" alt="Scan a wall">
        <p>Point your camera at a wall surface</p>
        <p>Tap to place the portal</p>
        <button id="start-button">Start AR</button>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/three@0.132.2/build/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.132.2/examples/js/loaders/GLTFLoader.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.132.2/examples/js/controls/XRControllerModelFactory.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.132.2/examples/js/webxr/ARButton.js"></script>

    <script>
        // Global variables
        let camera, scene, renderer, controller;
        let model, audio, audioContext;
        let reticle, hitTestSource = null;
        let modelPlaced = false;
        let assetsLoaded = 0;
        const totalAssets = 3; // Model, audio indicator image, instruction image

        // Check for WebXR and ARCore support
        if (!navigator.xr) {
            showError("WebXR not supported in your browser. Try Chrome on an ARCore-compatible Android device.");
        }

        // Main initialization function
        async function init() {
            // Create scene
            scene = new THREE.Scene();
            
            // Create camera
            camera = new THREE.PerspectiveCamera(70, window.innerWidth / window.innerHeight, 0.01, 20);
            
            // Create renderer
            renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
            renderer.setPixelRatio(window.devicePixelRatio);
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.xr.enabled = true;
            document.getElementById('ar-container').appendChild(renderer.domElement);
            
            // Add AR button
            const arButton = ARButton.createButton(renderer, { requiredFeatures: ['hit-test'] });
            document.getElementById('instructions').appendChild(arButton);
            arButton.style.display = 'none';
            
            // Set up controller
            controller = renderer.xr.getController(0);
            controller.addEventListener('select', onSelect);
            scene.add(controller);
            
            // Create reticle for placement preview
            reticle = new THREE.Mesh(
                new THREE.RingGeometry(0.05, 0.1, 32).rotateX(-Math.PI / 2),
                new THREE.MeshBasicMaterial({ color: 0xffffff, transparent: true, opacity: 0.5 })
            );
            reticle.visible = false;
            reticle.matrixAutoUpdate = false;
            scene.add(reticle);
            
            // Load assets
            try {
                await loadAssets();
                document.getElementById('loading').style.display = 'none';
                document.getElementById('instructions').style.display = 'flex';
            } catch (error) {
                showError("Failed to load assets: " + error.message);
            }
            
            // Handle window resize
            window.addEventListener('resize', onWindowResize);
            
            // Start render loop
            renderer.setAnimationLoop(render);
        }
        
        // Asset loading
        async function loadAssets() {
            return new Promise((resolve, reject) => {
                // Load 3D model
                const gltfLoader = new THREE.GLTFLoader();
                gltfLoader.load(
                    'PortalANimMus-02.glb',
                    (gltf) => {
                        model = gltf.scene;
                        model.visible = false;
                        scene.add(model);
                        assetLoaded();
                        resolve();
                    },
                    undefined,
                    (error) => {
                        reject(new Error('Failed to load 3D model'));
                    }
                );
                
                // Preload audio indicator image
                const img = new Image();
                img.src = 'earphone.png';
                img.onload = assetLoaded;
                img.onerror = () => reject(new Error('Failed to load audio indicator image'));
                
                // Preload instruction image
                const instructionImg = new Image();
                instructionImg.src = 'Firstimage.png';
                instructionImg.onload = assetLoaded;
                instructionImg.onerror = () => reject(new Error('Failed to load instruction image'));
            });
        }
        
        function assetLoaded() {
            assetsLoaded++;
            document.getElementById('loading').textContent = `Loading assets... (${assetsLoaded}/${totalAssets})`;
        }
        
        // Handle window resize
        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }
        
        // Handle tap/select event
        function onSelect() {
            if (modelPlaced || !reticle.visible) return;
            
            // Place model 50cm in front of the wall
            const position = new THREE.Vector3();
            const quaternion = new THREE.Quaternion();
            const scale = new THREE.Vector3();
            
            reticle.matrix.decompose(position, quaternion, scale);
            
            // Move 50cm forward from the wall
            const forward = new THREE.Vector3(0, 0, -0.5);
            forward.applyQuaternion(quaternion);
            position.add(forward);
            
            model.position.copy(position);
            model.quaternion.copy(quaternion);
            model.visible = true;
            modelPlaced = true;
            reticle.visible = false;
            
            // Show audio indicator
            const audioIndicator = document.getElementById('audio-indicator');
            audioIndicator.style.opacity = 1;
            
            // Fade out after 4 seconds
            setTimeout(() => {
                audioIndicator.style.opacity = 0;
            }, 4000);
            
            // Start audio after 5 seconds
            setTimeout(() => {
                initAudio();
                audio.play().catch(e => console.error("Audio play failed:", e));
            }, 5000);
            
            // Hide instructions
            document.getElementById('instructions').style.display = 'none';
        }
        
        // Initialize audio
        function initAudio() {
            audioContext = new (window.AudioContext || window.webkitAudioContext)();
            audio = new Audio('museumversion_250709.mp3');
            audio.loop = true;
            
            const source = audioContext.createMediaElementSource(audio);
            source.connect(audioContext.destination);
        }
        
        // Render loop
        function render() {
            if (!renderer.xr.isPresenting) return;
            
            // Update reticle position based on hit test
            if (controller && !modelPlaced) {
                const session = renderer.xr.getSession();
                if (session && hitTestSource) {
                    const referenceSpace = renderer.xr.getReferenceSpace();
                    const frame = renderer.xr.getFrame();
                    
                    const hitTestResults = frame.getHitTestResults(hitTestSource);
                    if (hitTestResults.length > 0) {
                        const hit = hitTestResults[0];
                        reticle.visible = true;
                        reticle.matrix.fromArray(hit.getPose(referenceSpace).transform.matrix);
                    } else {
                        reticle.visible = false;
                    }
                }
            }
            
            renderer.render(scene, camera);
        }
        
        // Show error message
        function showError(message) {
            const errorDiv = document.createElement('div');
            errorDiv.style.position = 'absolute';
            errorDiv.style.top = '0';
            errorDiv.style.left = '0';
            errorDiv.style.width = '100%';
            errorDiv.style.padding = '20px';
            errorDiv.style.backgroundColor = 'red';
            errorDiv.style.color = 'white';
            errorDiv.style.zIndex = '1000';
            errorDiv.textContent = message;
            document.body.appendChild(errorDiv);
            
            document.getElementById('loading').style.display = 'none';
            document.getElementById('instructions').style.display = 'none';
        }
        
        // Initialize hit test
        async function initializeXR() {
            const session = await navigator.xr.requestSession('immersive-ar', {
                requiredFeatures: ['hit-test']
            });
            
            const referenceSpace = await session.requestReferenceSpace('local');
            
            // Create hit test source
            const viewerSpace = await session.requestReferenceSpace('viewer');
            hitTestSource = await session.requestHitTestSource({
                space: viewerSpace,
                entityTypes: ['plane'],
                offsetRayOrigin: true
            });
            
            // Hide instructions and show AR button
            document.getElementById('start-button').style.display = 'none';
            document.querySelector('.ar-button').style.display = 'block';
            
            // Start AR session
            await renderer.xr.setSession(session);
        }
        
        // Start button click handler
        document.getElementById('start-button').addEventListener('click', async () => {
            try {
                await initializeXR();
            } catch (error) {
                showError("AR failed to start: " + error.message);
            }
        });
        
        // Start the application
        init().catch(error => {
            showError("Initialization failed: " + error.message);
        });
    </script>
</body>
</html>
